<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English OS Training - Full 3-Set Edition</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #fff9e6; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        #game-container { background: white; width: 90%; max-width: 500px; padding: 30px; border-radius: 30px; box-shadow: 0 15px 30px rgba(0,0,0,0.1); text-align: center; border: 4px solid #ffcc00; }
        .word-list { font-size: 2.2rem; font-weight: bold; color: #2d3436; margin: 20px 0; list-style: none; padding: 0; }
        .word-list li { background: #fff3bf; margin: 8px 0; padding: 10px; border-radius: 12px; color: #e67e22; border-left: 6px solid #ffcc00; }
        .word-display { font-size: 1.8rem; font-weight: bold; color: #0984e3; margin: 20px 0; min-height: 80px; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 8px; }
        .timer-bar { width: 100%; height: 15px; background: #dfe6e9; border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
        .timer-fill { height: 100%; background: #ff7675; width: 100%; transition: width 20s linear; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        button { padding: 15px; font-size: 1.1rem; border: none; border-radius: 12px; background: #74b9ff; color: white; cursor: pointer; transition: 0.2s; font-weight: bold; box-shadow: 0 4px 0 #0984e3; }
        button:active { transform: translateY(2px); box-shadow: none; }
        button:disabled { opacity: 0.5; }
        .error { color: #d63031 !important; animation: shake 0.5s; }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }
        .hidden { display: none; }
        .countdown { font-size: 5rem; color: #fab1a0; font-weight: bold; }
        #progress { font-size: 1.1rem; color: #b2bec3; margin-bottom: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="progress">SET 1 / 3</div>
    <div id="message">READY?</div>
    <div id="countdown-screen" class="countdown"></div>

    <div id="step1" class="hidden">
        <h3 style="color:#e67e22">【1】20秒で 5単語を記憶！</h3>
        <ul id="word-list-area" class="word-list"></ul>
        <div class="timer-bar"><div id="timer1" class="timer-fill"></div></div>
    </div>

    <div id="step2" class="hidden">
        <h3 style="color:#0984e3">【2】文法を高速処理！</h3>
        <p id="sentence-hint" style="font-size:1.3rem; font-weight:bold; color:#2d3436;"></p>
        <div id="sort-area" class="word-display"></div>
        <div id="sort-options" class="btn-grid"></div>
    </div>

    <div id="step3" class="hidden">
        <h3 style="color:#6c5ce7">【3】記憶を再認！</h3>
        <div id="recall-options" class="btn-grid"></div>
    </div>

    <div id="result" class="hidden">
        <h2 style="color:#ff7675; font-size:2rem;">トレーニング完了！</h2>
        <div id="final-stats" style="background:#fff9e6; padding:20px; border-radius:20px; margin:20px 0; border: 2px dashed #ffcc00; text-align: left;"></div>
        <button onclick="location.reload()" style="width:100%; background:#55efc4; box-shadow: 0 4px 0 #00b894;">もう一度挑戦</button>
    </div>
</div>

<script>
    // 単語プール（意味は記憶中は非表示）
    let wordPool = [
        {en: "Apple", jp: "りんご"}, {en: "Dog", jp: "いぬ"}, {en: "Book", jp: "本"},
        {en: "Cat", jp: "ねこ"}, {en: "Friend", jp: "ともだち"}, {en: "Music", jp: "音楽"},
        {en: "Pencil", jp: "えんぴつ"}, {en: "School", jp: "学校"}, {en: "Water", jp: "水"},
        {en: "Summer", jp: "夏"}, {en: "Sport", jp: "スポーツ"}, {en: "English", jp: "英語"},
        {en: "Table", jp: "机"}, {en: "Teacher", jp: "先生"}, {en: "Library", jp: "図書館"}
    ];

    // 文法プール
    let sentencePool = [
        { q: "私は幸せです", correct: ["I", "am", "happy"] },
        { q: "あなたは先生です", correct: ["You", "are", "a", "teacher"] },
        { q: "これはペンです", correct: ["This", "is", "a", "pen"] },
        { q: "彼女は忙しくない", correct: ["She", "is", "not", "busy"] },
        { q: "あなたは元気？", correct: ["Are", "you", "fine?"] },
        { q: "あれは私の本です", correct: ["That", "is", "my", "book"] },
        { q: "私たちは学生です", correct: ["We", "are", "students"] },
        { q: "健二は親切です", correct: ["Kenji", "is", "kind"] },
        { q: "これは何ですか？", correct: ["What", "is", "this?"] }
    ];

    let currentSet = 1;
    const maxSets = 3;
    let totalRecall = 0;
    let totalTime = 0;
    
    let sessionWords = [], sessionSentences = [], setStartTime, recallCount = 0, currentSortIndex = 0, userSort = [];

    window.onload = startCountdown;

    function startCountdown() {
        document.getElementById('progress').innerText = `SET ${currentSet} / ${maxSets}`;
        document.getElementById('message').innerText = "READY?";
        let count = 3;
        const cdDiv = document.getElementById('countdown-screen');
        cdDiv.classList.remove('hidden');
        const timer = setInterval(() => {
            if (count > 0) { cdDiv.innerText = count; count--; }
            else { clearInterval(timer); cdDiv.classList.add('hidden'); startStep1(); }
        }, 1000);
    }

    function startStep1() {
        document.getElementById('message').innerText = "MEMORIZE!";
        document.getElementById('step1').classList.remove('hidden');
        
        // 使用済みの単語をプールから削除してセットの重複を防ぐ
        sessionWords = [];
        for(let i=0; i<5; i++) {
            const idx = Math.floor(Math.random() * wordPool.length);
            sessionWords.push(wordPool.splice(idx, 1)[0]);
        }

        document.getElementById('word-list-area').innerHTML = sessionWords.map(w => `<li>${w.en}</li>`).join('');
        
        const bar = document.getElementById('timer1');
        bar.style.transition = 'none'; bar.style.width = '100%';
        setTimeout(() => { bar.style.transition = 'width 20s linear'; bar.style.width = '0%'; }, 10);
        
        setTimeout(startStep2, 20000);
    }

    function startStep2() {
        document.getElementById('message').innerText = "SPEED!";
        document.getElementById('step1').classList.add('hidden');
        document.getElementById('step2').classList.remove('hidden');
        
        // 使用済みの文法をプールから削除してセットの重複を防ぐ
        sessionSentences = [];
        for(let i=0; i<3; i++) {
            const idx = Math.floor(Math.random() * sentencePool.length);
            sessionSentences.push(sentencePool.splice(idx, 1)[0]);
        }

        currentSortIndex = 0;
        setStartTime = performance.now();
        showSortQuestion();
    }

    function showSortQuestion() {
        if (currentSortIndex >= sessionSentences.length) {
            totalTime += (performance.now() - setStartTime);
            startStep3();
            return;
        }
        const s = sessionSentences[currentSortIndex];
        const displayArea = document.getElementById('sort-area');
        const optDiv = document.getElementById('sort-options');
        document.getElementById('sentence-hint').innerText = s.q;
        displayArea.innerText = "____";
        displayArea.classList.remove('error');
        
        const options = [...s.correct, "is", "are", "am"].filter((v, i, a) => a.indexOf(v) === i).sort(() => 0.5 - Math.random());
        optDiv.innerHTML = '';
        userSort = [];

        options.forEach(word => {
            const btn = document.createElement('button');
            btn.innerText = word;
            btn.onclick = () => {
                if (word === s.correct[userSort.length]) {
                    userSort.push(word);
                    displayArea.innerText = userSort.join(" ");
                    if (userSort.length === s.correct.length) {
                        currentSortIndex++;
                        setTimeout(showSortQuestion, 400);
                    }
                } else {
                    displayArea.classList.add('error');
                    setTimeout(() => { displayArea.classList.remove('error'); userSort = []; displayArea.innerText = "もういちど！"; }, 500);
                }
            };
            optDiv.appendChild(btn);
        });
    }

    function startStep3() {
        document.getElementById('message').innerText = "RECALL!";
        document.getElementById('step2').classList.add('hidden');
        document.getElementById('step3').classList.remove('hidden');
        const recallDiv = document.getElementById('recall-options');
        recallDiv.innerHTML = '';
        recallCount = 0;

        // 全体の単語リストからダミーを作成
        const dummyPool = [
            {jp: "海"}, {jp: "空"}, {jp: "夢"}, {jp: "愛"}, {jp: "家"}, {jp: "星"}
        ];
        const allOptions = [...sessionWords, ...dummyPool.slice(0, 3)].sort(() => 0.5 - Math.random());
        
        allOptions.forEach(word => {
            const btn = document.createElement('button');
            btn.innerText = word.jp;
            btn.onclick = () => {
                if(sessionWords.find(w => w.jp === word.jp)) {
                    recallCount++; totalRecall++;
                    btn.style.background = "#55efc4";
                } else { btn.style.background = "#ff7675"; }
                btn.disabled = true;
                if(document.querySelectorAll('#recall-options button[disabled]').length === 5) {
                    setTimeout(nextSet, 1000);
                }
            };
            recallDiv.appendChild(btn);
        });
    }

    function nextSet() {
        document.getElementById('step3').classList.add('hidden');
        if (currentSet < maxSets) {
            currentSet++;
            startCountdown();
        } else {
            showFinalResult();
        }
    }

    function showFinalResult() {
        document.getElementById('message').innerText = "FINISH!";
        document.getElementById('progress').innerText = "RESULT";
        const resultSection = document.getElementById('result');
        resultSection.classList.remove('hidden');
        
        const totalSeconds = (totalTime / 1000).toFixed(2);
        const wordScore = totalRecall * 200;
        const speedBonus = Math.max(0, Math.round((100000 - totalTime) / 100));
        
        document.getElementById('final-stats').innerHTML = `
            <p>■ 文法合計タイム: <span style="font-size:1.6rem; color:#e17055; font-weight:bold;">${totalSeconds}</span> 秒</p>
            <p>■ 単語リテンション: <span style="font-weight:bold; color:#6c5ce7; font-size:1.6rem;">${totalRecall}</span> / 15</p>
            <hr style="border:1px dashed #ffcc00;">
            <p style="font-size:2.2rem; text-align:center;"><strong>OSスコア: <span style="color:#00b894">${wordScore + speedBonus}</span></strong></p>
        `;
    }
</script>
</body>
</html>